# Mock DB For Testing HTTP API with Gomock

## Why mock database?

1. Independent Tests

- Isolate tests data to avoid conflicts

2. Faster Tests

- Reduce a lot of time talking to the database

3. 100% Coverage

- Easily setup edge cases: unexpected errors

## Is it good enough to test our API with a mock DB?

Yes! Our real DB store is already tested previously. We just need to make sure mock DB and real DB should implement the same interface.

## How to mock?

1. Use fake db: memory

Implement a fake verison of DB: store data in memory.

2. Use db stubs: `Gomock`

Generate and build stubs that return hard-coded values.

Install `Gomock`:

```shell
go install github.com/golang/mock/mockgen@v1.6.0
```

Update `sqlc.yaml`:

Change false to true in `emit_interface`

```yml
emit_interface: true
```

Regenrate Go codes using sqlc:

```shell
make sqlc
```

Then you will see a new file named `querier.go` generated in `/db/sqlc/`.

```go
// querier.go
// Code generated by sqlc. DO NOT EDIT.

package db

import (
	"context"
)

type Querier interface {
	AddAccountBalance(ctx context.Context, arg AddAccountBalanceParams) (Account, error)
	CreateAccount(ctx context.Context, arg CreateAccountParams) (Account, error)
	CreateEntry(ctx context.Context, arg CreateEntryParams) (Entry, error)
	CreateTransfer(ctx context.Context, arg CreateTransferParams) (Transfer, error)
	DeleteAccount(ctx context.Context, id int64) error
	GetAccount(ctx context.Context, id int64) (Account, error)
	GetAccountForUpdate(ctx context.Context, id int64) (Account, error)
	GetEntry(ctx context.Context, id int64) (Entry, error)
	GetTransfer(ctx context.Context, id int64) (Transfer, error)
	ListAccounts(ctx context.Context, arg ListAccountsParams) ([]Account, error)
	ListEntries(ctx context.Context, arg ListEntriesParams) ([]Entry, error)
	ListTransfers(ctx context.Context, arg ListTransfersParams) ([]Transfer, error)
	UpdateAccount(ctx context.Context, arg UpdateAccountParams) (Account, error)
}

var _ Querier = (*Queries)(nil)
```

Run `mockgen`:

```shell
$ mockgen -package mockdb -destination db/mock/store.go github.com/youngjae-lim/fakebank/db/sqlc Store
```

You can find `store.go` file generated in the `/db/mock/` directory.

Add `mock` command to the `Makefile`.

```Makefile
mock:
	mockgen -package mockdb -destination db/mock/store.go github.com/youngjae-lim/fakebank/db/sqlc Store
```

Now start making some test script:

Create `account_test.go` in the `/api` directory.

```go
// account_test.go
```
